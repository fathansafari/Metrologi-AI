<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetrologyPro AI - Dark Mode</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel (untuk memproses JSX di browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Font Awesome (Pengganti Lucide untuk versi HTML Standalone agar lebih stabil) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        /* Markdown Styles */
        .prose p { margin-bottom: 0.8em; line-height: 1.6; }
        .prose h1, .prose h2, .prose h3 { color: #e2e8f0; font-weight: 700; margin-top: 1em; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .prose ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 1em; }
        .prose strong { color: #fff; font-weight: 600; }
        .prose a { color: #60a5fa; text-decoration: underline; }
        .prose blockquote { border-left: 4px solid #475569; padding-left: 1em; color: #94a3b8; font-style: italic; }

        /* Animation */
        @keyframes bounce-delay {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }
        .animate-bounce-delay { animation: bounce-delay 1s infinite; }
    </style>
</head>
<body class="bg-[#0f172a] text-slate-200 h-screen overflow-hidden selection:bg-blue-500 selection:text-white">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- KONFIGURASI API ---
        const API_KEY = "AIzaSyCHQbkmex1buEVSLGJHMFeSDuH6BQTCE8w";
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";

        const MetrologyProApp = () => {
            // State
            const [messages, setMessages] = useState([
                {
                    id: 1,
                    role: 'ai',
                    text: "Halo. Saya **MetrologyPro AI**. \n\nSaya terhubung langsung ke internet untuk memberikan informasi regulasi, teknis, dan berita metrologi terkini.\n\nApa yang bisa saya bantu hari ini?",
                    sources: []
                }
            ]);
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [selectedModel, setSelectedModel] = useState('flash'); // 'flash' or 'pro'
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            
            const messagesEndRef = useRef(null);

            // Auto-scroll
            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages, isLoading]);

            // Fungsi Kirim Pesan
            const handleSend = async (e) => {
                e.preventDefault();
                if (!input.trim() || isLoading) return;

                const userMessage = { id: Date.now(), role: 'user', text: input };
                setMessages(prev => [...prev, userMessage]);
                setInput('');
                setIsLoading(true);

                try {
                    // 1. History Context (Limit 5 pesan terakhir)
                    const history = messages.slice(-5).map(msg => ({
                        role: msg.role === 'ai' ? 'model' : 'user',
                        parts: [{ text: msg.text }]
                    }));

                    // 2. System Prompt
                    const modeInstruction = selectedModel === 'pro' 
                        ? "Berikan jawaban yang sangat detail, analitis, dan mendalam. Gunakan bahasa formal akademik/pemerintahan."
                        : "Berikan jawaban yang ringkas, padat, dan langsung pada intinya (to-the-point).";

                    const systemPrompt = `
                        Anda adalah MetrologyPro AI, asisten resmi Direktorat Metrologi.
                        Tugas: Menjawab pertanyaan tentang metrologi, hukum, regulasi, dan teknis.
                        
                        INSTRUKSI PENTING:
                        1. Anda memiliki akses ke GOOGLE SEARCH. GUNAKAN ITU untuk mencari data fakta terbaru.
                        2. Jangan mengarang hukum atau pasal. Wajib menyertakan sumber jika mengambil data online.
                        3. Gaya bicara: Profesional, Sopan, Menggunakan istilah baku Bahasa Indonesia.
                        4. Mode saat ini: ${modeInstruction}
                    `;

                    // 3. Panggil API Gemini
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [...history, { role: 'user', parts: [{ text: input }] }],
                                systemInstruction: { parts: [{ text: systemPrompt }] },
                                tools: [{ google_search: {} }],
                                generationConfig: {
                                    temperature: selectedModel === 'pro' ? 0.7 : 0.3,
                                }
                            })
                        }
                    );

                    const data = await response.json();

                    if (!response.ok) throw new Error(data.error?.message || "Gagal menghubungi server");

                    // 4. Ekstrak Data
                    const candidate = data.candidates?.[0];
                    const aiText = candidate?.content?.parts?.[0]?.text || "Maaf, saya tidak menemukan jawaban.";
                    
                    // Ekstrak Sumber (Grounding)
                    const groundingChunks = candidate?.groundingMetadata?.groundingChunks || [];
                    const sources = groundingChunks
                        .filter(chunk => chunk.web?.uri)
                        .map(chunk => ({
                            title: chunk.web?.title || "Sumber Web",
                            uri: chunk.web?.uri
                        }));
                    
                    // Hapus duplikasi sumber
                    const uniqueSources = Array.from(new Set(sources.map(a => a.uri)))
                        .map(uri => sources.find(a => a.uri === uri));

                    const aiMessage = {
                        id: Date.now() + 1,
                        role: 'ai',
                        text: aiText,
                        sources: uniqueSources
                    };

                    setMessages(prev => [...prev, aiMessage]);

                } catch (error) {
                    setMessages(prev => [...prev, {
                        id: Date.now() + 1,
                        role: 'ai',
                        text: `⚠️ **Error Sistem:** ${error.message}. Coba lagi nanti.`,
                        isError: true
                    }]);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleClearChat = () => {
                setMessages([{
                    id: 1,
                    role: 'ai',
                    text: "Halo. Saya **MetrologyPro AI**. \n\nSaya terhubung langsung ke internet untuk memberikan informasi regulasi, teknis, dan berita metrologi terkini.\n\nApa yang bisa saya bantu hari ini?",
                    sources: []
                }]);
                setIsSidebarOpen(false);
            };

            // Render Markdown
            const renderMarkdown = (text) => {
                return { __html: marked.parse(text) };
            };

            return (
                <div className="flex h-screen bg-[#0f172a] text-slate-200 overflow-hidden">
                    
                    {/* --- SIDEBAR --- */}
                    <div className={`fixed inset-y-0 left-0 z-50 w-72 bg-[#1e293b] border-r border-slate-700 transform transition-transform duration-300 ease-in-out md:relative md:translate-x-0 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="flex flex-col h-full">
                            
                            {/* Logo Area */}
                            <div className="p-6 border-b border-slate-700 flex items-center gap-3">
                                <div className="bg-gradient-to-br from-blue-600 to-cyan-400 w-10 h-10 flex items-center justify-center rounded-lg shadow-lg shadow-blue-500/20">
                                    <i className="fa-solid fa-shield-halved text-white text-lg"></i>
                                </div>
                                <div>
                                    <h1 className="font-bold text-lg tracking-wide text-white">Metrology<span className="text-blue-400">Pro</span></h1>
                                    <p className="text-[10px] text-slate-400 uppercase tracking-widest">Direktorat Metrologi</p>
                                </div>
                                <button onClick={() => setIsSidebarOpen(false)} className="md:hidden ml-auto text-slate-400 hover:text-white">
                                    <i className="fa-solid fa-xmark text-xl"></i>
                                </button>
                            </div>

                            {/* Model Selection */}
                            <div className="p-6 flex-1 overflow-y-auto">
                                <h3 className="text-xs font-semibold text-slate-500 uppercase mb-4 tracking-wider">Model AI</h3>
                                
                                <div className="space-y-3">
                                    <button 
                                        onClick={() => setSelectedModel('flash')}
                                        className={`w-full flex items-center gap-3 p-3 rounded-xl border transition-all duration-200 ${selectedModel === 'flash' ? 'bg-blue-600/20 border-blue-500/50 ring-1 ring-blue-500' : 'bg-slate-800/50 border-slate-700 hover:bg-slate-800'}`}
                                    >
                                        <div className={`w-8 h-8 flex items-center justify-center rounded-lg ${selectedModel === 'flash' ? 'bg-blue-500 text-white' : 'bg-slate-700 text-slate-400'}`}>
                                            <i className="fa-solid fa-bolt"></i>
                                        </div>
                                        <div className="text-left">
                                            <div className={`text-sm font-medium ${selectedModel === 'flash' ? 'text-blue-200' : 'text-slate-300'}`}>Gemini Flash</div>
                                            <div className="text-[10px] text-slate-500">Respon Cepat & Ringkas</div>
                                        </div>
                                    </button>

                                    <button 
                                        onClick={() => setSelectedModel('pro')}
                                        className={`w-full flex items-center gap-3 p-3 rounded-xl border transition-all duration-200 ${selectedModel === 'pro' ? 'bg-purple-600/20 border-purple-500/50 ring-1 ring-purple-500' : 'bg-slate-800/50 border-slate-700 hover:bg-slate-800'}`}
                                    >
                                        <div className={`w-8 h-8 flex items-center justify-center rounded-lg ${selectedModel === 'pro' ? 'bg-purple-500 text-white' : 'bg-slate-700 text-slate-400'}`}>
                                            <i className="fa-solid fa-wand-magic-sparkles"></i>
                                        </div>
                                        <div className="text-left">
                                            <div className={`text-sm font-medium ${selectedModel === 'pro' ? 'text-purple-200' : 'text-slate-300'}`}>Gemini Pro</div>
                                            <div className="text-[10px] text-slate-500">Analisis Mendalam</div>
                                        </div>
                                    </button>
                                </div>

                                <div className="mt-8">
                                    <h3 className="text-xs font-semibold text-slate-500 uppercase mb-4 tracking-wider">Status Sistem</h3>
                                    <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700 space-y-3">
                                        <div className="flex items-center justify-between text-xs">
                                            <span className="text-slate-400">Koneksi Internet</span>
                                            <span className="text-green-400 flex items-center gap-1"><span className="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse"></span> Online</span>
                                        </div>
                                        <div className="flex items-center justify-between text-xs">
                                            <span className="text-slate-400">Google Search</span>
                                            <span className="text-blue-400">Aktif</span>
                                        </div>
                                        <div className="flex items-center justify-between text-xs">
                                            <span className="text-slate-400">API Key</span>
                                            <span className="text-slate-200 font-mono bg-slate-900 px-1 rounded">AIzaSy...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Footer Sidebar */}
                            <div className="p-4 border-t border-slate-700">
                                <button onClick={handleClearChat} className="flex items-center justify-center gap-2 w-full p-2 text-sm text-red-400 hover:bg-red-900/20 hover:text-red-300 rounded-lg transition-colors">
                                    <i className="fa-solid fa-trash-can"></i>
                                    <span>Reset Percakapan</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* --- MAIN CHAT AREA --- */}
                    <div className="flex-1 flex flex-col relative w-full max-w-full">
                        
                        {/* Header Mobile */}
                        <div className="md:hidden p-4 bg-[#0f172a] border-b border-slate-700 flex justify-between items-center z-10 sticky top-0">
                            <div className="flex items-center gap-2">
                                <i className="fa-solid fa-shield-halved text-blue-500"></i>
                                <span className="font-bold text-slate-200">MetrologyPro</span>
                            </div>
                            <button onClick={() => setIsSidebarOpen(true)} className="text-slate-300">
                                <i className="fa-solid fa-bars text-xl"></i>
                            </button>
                        </div>

                        {/* Messages Container */}
                        <div className="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 custom-scrollbar scroll-smooth">
                            {messages.map((msg) => (
                                <div key={msg.id} className={`flex gap-4 max-w-4xl mx-auto ${msg.role === 'user' ? 'justify-end' : ''}`}>
                                    
                                    {/* Avatar AI */}
                                    {msg.role === 'ai' && (
                                        <div className="w-10 h-10 rounded-full bg-gradient-to-br from-blue-600 to-cyan-500 flex items-center justify-center flex-shrink-0 shadow-lg shadow-blue-900/20">
                                            <i className="fa-solid fa-robot text-white"></i>
                                        </div>
                                    )}

                                    {/* Chat Bubble */}
                                    <div className={`flex flex-col gap-2 max-w-[85%] md:max-w-[75%]`}>
                                        <div className={`text-xs font-bold ${msg.role === 'user' ? 'text-right text-slate-400' : 'text-blue-400'} mb-1`}>
                                            {msg.role === 'user' ? 'Anda' : 'MetrologyPro AI'}
                                        </div>
                                        
                                        <div className={`p-4 md:p-6 rounded-2xl text-sm leading-relaxed shadow-md 
                                            ${msg.role === 'user' 
                                                ? 'bg-blue-600 text-white rounded-tr-none' 
                                                : 'bg-[#1e293b] text-slate-200 border border-slate-700 rounded-tl-none'
                                            }`}>
                                            
                                            {/* Render Markdown Content */}
                                            <div className="prose prose-sm max-w-none" dangerouslySetInnerHTML={renderMarkdown(msg.text)}></div>

                                            {/* Sources Section (If Any) */}
                                            {msg.sources && msg.sources.length > 0 && (
                                                <div className="mt-4 pt-4 border-t border-slate-600/50">
                                                    <div className="flex items-center gap-2 text-xs font-semibold text-slate-400 mb-2">
                                                        <i className="fa-solid fa-magnifying-glass"></i>
                                                        <span>Sumber Referensi Web:</span>
                                                    </div>
                                                    <div className="flex flex-wrap gap-2">
                                                        {msg.sources.map((src, idx) => (
                                                            <a 
                                                                key={idx} 
                                                                href={src.uri} 
                                                                target="_blank" 
                                                                rel="noopener noreferrer"
                                                                className="flex items-center gap-1.5 px-3 py-1.5 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-full text-xs text-blue-300 transition-colors truncate max-w-[200px]"
                                                            >
                                                                <i className="fa-solid fa-up-right-from-square text-[10px]"></i>
                                                                <span className="truncate">{src.title}</span>
                                                            </a>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    {/* Avatar User */}
                                    {msg.role === 'user' && (
                                        <div className="w-10 h-10 rounded-full bg-slate-700 border border-slate-600 flex items-center justify-center flex-shrink-0">
                                            <i className="fa-solid fa-user text-slate-400"></i>
                                        </div>
                                    )}
                                </div>
                            ))}

                            {/* Loading Indicator */}
                            {isLoading && (
                                <div className="flex gap-4 max-w-4xl mx-auto animate-pulse">
                                    <div className="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center border border-slate-700">
                                        <i className="fa-solid fa-robot text-slate-500"></i>
                                    </div>
                                    <div className="bg-[#1e293b] border border-slate-700 px-6 py-4 rounded-2xl rounded-tl-none flex items-center gap-2">
                                        <div className="w-2 h-2 bg-blue-500 rounded-full animate-bounce-delay" style={{animationDelay: '0s'}}></div>
                                        <div className="w-2 h-2 bg-blue-500 rounded-full animate-bounce-delay" style={{animationDelay: '0.2s'}}></div>
                                        <div className="w-2 h-2 bg-blue-500 rounded-full animate-bounce-delay" style={{animationDelay: '0.4s'}}></div>
                                        <span className="text-xs text-slate-400 ml-2">Mencari data di internet...</span>
                                    </div>
                                </div>
                            )}
                            
                            <div ref={messagesEndRef} />
                        </div>

                        {/* Input Area */}
                        <div className="p-4 md:p-6 bg-[#0f172a] border-t border-slate-700 z-20">
                            <div className="max-w-4xl mx-auto">
                                <form onSubmit={handleSend} className="relative flex items-end gap-2 p-2 bg-[#1e293b] border border-slate-600 rounded-xl focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-transparent transition-all shadow-lg shadow-black/20">
                                    
                                    <textarea
                                        value={input}
                                        onChange={(e) => setInput(e.target.value)}
                                        onKeyDown={(e) => {
                                            if (e.key === 'Enter' && !e.shiftKey) {
                                                e.preventDefault();
                                                handleSend(e);
                                            }
                                        }}
                                        placeholder="Tanyakan tentang regulasi tera, standar ukuran, atau berita metrologi terbaru..."
                                        className="w-full bg-transparent border-none text-slate-200 placeholder-slate-500 focus:ring-0 resize-none max-h-32 min-h-[44px] py-3 px-3 text-sm focus:outline-none"
                                        rows="1"
                                        style={{ height: 'auto', minHeight: '44px' }}
                                    ></textarea>
                                    
                                    <button 
                                        type="submit" 
                                        disabled={!input.trim() || isLoading}
                                        className="mb-1 p-2.5 bg-blue-600 hover:bg-blue-500 disabled:bg-slate-700 disabled:text-slate-500 text-white rounded-lg transition-all flex-shrink-0 shadow-md cursor-pointer disabled:cursor-not-allowed"
                                    >
                                        <i className="fa-solid fa-paper-plane text-lg"></i>
                                    </button>
                                </form>
                                <div className="mt-2 text-center">
                                    <p className="text-[10px] text-slate-500 flex items-center justify-center gap-1.5">
                                        <i className="fa-solid fa-bolt text-yellow-500"></i>
                                        Didukung oleh Google Gemini 2.5 Flash & Google Search Grounding
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MetrologyProApp />);
    </script>
</body>
</html>

