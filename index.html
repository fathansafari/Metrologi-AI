<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetrologyPro AI - Smart History System</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #09090b;
            --bg-sidebar: #050505;
            --accent: #3b82f6;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-dark); color: #e4e4e7; overflow: hidden; }
        
        .scroller::-webkit-scrollbar { width: 5px; }
        .scroller::-webkit-scrollbar-track { background: transparent; }
        .scroller::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 10px; }
        
        .glass { background: rgba(24, 24, 27, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); }
        .glass-popover { background: rgba(30, 30, 35, 0.95); backdrop-filter: blur(16px); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); }

        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slideUp 0.2s ease-out forwards; }
        
        .typing-dot { animation: pulse 1s infinite; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .prose p { margin-bottom: 0.5em; line-height: 1.6; }
        .prose strong { color: #fff; }
        .prose a { color: #60a5fa; }
        .prose ul { list-style: disc; padding-left: 1.5em; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const API_KEY = "AIzaSyCHQbkmex1buEVSLGJHMFeSDuH6BQTCE8w"; 
        const MODEL = "gemini-2.5-flash-preview-09-2025";
        
        // --- HELPER FUNCTIONS ---
        const generateId = () => Math.random().toString(36).substr(2, 9);
        const getCurrentTime = () => new Date().toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});

        // --- COMPONENTS ---

        // 1. Sidebar Item
        const HistoryItem = ({ session, isActive, onClick, onDelete }) => (
            <div className={`group flex items-center gap-3 px-3 py-3 rounded-lg cursor-pointer transition-all border ${isActive ? 'bg-[#1e1e22] border-white/10 text-white' : 'border-transparent text-gray-400 hover:bg-white/5 hover:text-gray-200'}`} onClick={onClick}>
                <i className={`fa-regular fa-message text-xs ${isActive ? 'text-blue-400' : 'opacity-70'}`}></i>
                <div className="flex-1 overflow-hidden">
                    <p className="text-sm font-medium truncate">{session.title}</p>
                    <p className="text-[10px] opacity-60 truncate">{session.timestamp.toLocaleDateString()}</p>
                </div>
                {/* Delete button (hidden by default, shown on hover) */}
                <button onClick={(e) => { e.stopPropagation(); onDelete(); }} className="opacity-0 group-hover:opacity-100 p-1 hover:text-red-400 transition-opacity">
                    <i className="fa-solid fa-xmark text-xs"></i>
                </button>
            </div>
        );

        // 2. Drive Modal
        const DrivePickerModal = ({ isOpen, onClose, onSelect }) => {
            if (!isOpen) return null;
            const [loading, setLoading] = useState(true);
            
            useEffect(() => {
                if (isOpen) {
                    setLoading(true);
                    setTimeout(() => setLoading(false), 1200); 
                }
            }, [isOpen]);

            const files = [
                { name: "Laporan_Tera_Tahunan_2024.pdf", type: "pdf", size: "2.5 MB" },
                { name: "Foto_Alat_Ukur_Pasar.jpg", type: "image", size: "1.2 MB" },
                { name: "SOP_Pengawasan_UTTP.docx", type: "doc", size: "800 KB" }
            ];

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4">
                    <div className="glass-popover w-full max-w-md rounded-xl overflow-hidden animate-slide-up">
                        <div className="p-4 border-b border-white/10 flex justify-between items-center bg-[#18181b]">
                            <h3 className="font-semibold text-white flex items-center gap-2"><i className="fa-brands fa-google-drive text-green-500"></i> Google Drive</h3>
                            <button onClick={onClose}><i className="fa-solid fa-xmark text-gray-400"></i></button>
                        </div>
                        <div className="p-4 min-h-[200px]">
                            {loading ? (
                                <div className="flex flex-col items-center justify-center h-48 gap-3 text-gray-400">
                                    <i className="fa-solid fa-circle-notch fa-spin text-2xl text-blue-500"></i>
                                    <span className="text-xs">Menghubungkan ke Drive...</span>
                                </div>
                            ) : (
                                <div className="space-y-2">
                                    {files.map((f, i) => (
                                        <button key={i} onClick={() => onSelect(f)} className="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-white/5 text-left group border border-transparent hover:border-white/5">
                                            <div className={`w-8 h-8 rounded flex items-center justify-center ${f.type === 'pdf' ? 'bg-red-500/20 text-red-400' : f.type === 'image' ? 'bg-blue-500/20 text-blue-400' : 'bg-blue-600/20 text-blue-300'}`}>
                                                <i className={`fa-solid ${f.type === 'pdf' ? 'fa-file-pdf' : f.type === 'image' ? 'fa-image' : 'fa-file'}`}></i>
                                            </div>
                                            <div>
                                                <p className="text-sm text-gray-200 group-hover:text-blue-400">{f.name}</p>
                                                <p className="text-[10px] text-gray-500">{f.size}</p>
                                            </div>
                                        </button>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN APP ---
        const App = () => {
            // -- STATE --
            const [user, setUser] = useState(null);
            
            // HISTORY STATE: Array of session objects
            const [sessions, setSessions] = useState([
                {
                    id: 'init',
                    title: 'Chat Baru',
                    timestamp: new Date(),
                    messages: [
                        { id: 'welcome', role: 'ai', text: "Halo. Saya **MetrologyPro AI**.\n\nSilakan ajukan pertanyaan atau unggah dokumen untuk memulai.", timestamp: getCurrentTime() }
                    ]
                }
            ]);
            const [activeSessionId, setActiveSessionId] = useState('init');
            
            const [input, setInput] = useState("");
            const [isLoading, setIsLoading] = useState(false);
            const [isSidebarOpen, setIsSidebarOpen] = useState(true);
            const [isMenuOpen, setIsMenuOpen] = useState(false);
            const [attachments, setAttachments] = useState([]);
            const [showDrive, setShowDrive] = useState(false);

            // Refs
            const messagesEndRef = useRef(null);
            const fileInputRef = useRef(null);
            const pdfInputRef = useRef(null);
            const menuRef = useRef(null);

            // Derived State
            const activeSession = sessions.find(s => s.id === activeSessionId) || sessions[0];
            const currentMessages = activeSession.messages;

            // Effects
            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [currentMessages, isLoading]);
            
            // Click outside menu
            useEffect(() => {
                const handleClickOutside = (event) => { if (menuRef.current && !menuRef.current.contains(event.target)) setIsMenuOpen(false); };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            // -- HANDLERS --

            const createNewSession = () => {
                const newId = generateId();
                const newSession = {
                    id: newId,
                    title: 'Chat Baru', // Default title before first query
                    timestamp: new Date(),
                    messages: [
                        { id: generateId(), role: 'ai', text: "Sesi baru dimulai. Ada yang bisa saya bantu?", timestamp: getCurrentTime() }
                    ]
                };
                setSessions(prev => [newSession, ...prev]); // Add to top
                setActiveSessionId(newId);
                if(window.innerWidth < 768) setIsSidebarOpen(false);
            };

            const deleteSession = (idToDelete) => {
                const filtered = sessions.filter(s => s.id !== idToDelete);
                if (filtered.length === 0) {
                    // If all deleted, create new default
                    setSessions([{ id: 'new', title: 'Chat Baru', timestamp: new Date(), messages: [{ id: 'w', role: 'ai', text: "Siap membantu.", timestamp: getCurrentTime() }] }]);
                    setActiveSessionId('new');
                } else {
                    setSessions(filtered);
                    if (activeSessionId === idToDelete) setActiveSessionId(filtered[0].id);
                }
            };

            const handleLogin = () => {
                setUser({
                    name: "Andi Saputra",
                    email: "andi.upt@metrologi.go.id",
                    avatar: "https://ui-avatars.com/api/?name=Andi+Saputra&background=3b82f6&color=fff"
                });
            };

            const handleFileSelect = (e, type) => {
                if (e.target.files[0]) {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    reader.onload = (ev) => {
                        setAttachments(prev => [...prev, { name: file.name, type, preview: type === 'image' ? ev.target.result : null, file }]);
                        setIsMenuOpen(false);
                    };
                    reader.readAsDataURL(file);
                }
                e.target.value = null;
            };

            const handleDriveSelect = (file) => {
                setAttachments(prev => [...prev, { name: file.name, type: file.type, fromDrive: true }]);
                setShowDrive(false);
                setIsMenuOpen(false);
            };

            const handleSend = async (e) => {
                e.preventDefault();
                if ((!input.trim() && attachments.length === 0) || isLoading) return;

                const userMsgId = generateId();
                const userText = input;
                const userAtts = [...attachments];
                
                // 1. Update UI with User Message immediately
                setSessions(prev => prev.map(session => {
                    if (session.id === activeSessionId) {
                        // LOGIC UPDATE JUDUL: Jika ini pesan user pertama (setelah greeting AI), update judul
                        // Pesan ke-0 biasanya AI greeting. Pesan ke-1 adalah User.
                        const isFirstUserMsg = session.messages.length === 1 && session.messages[0].role === 'ai';
                        let newTitle = session.title;
                        
                        if (isFirstUserMsg) {
                            // Ambil 4-5 kata pertama atau potong string
                            newTitle = userText.split(' ').slice(0, 5).join(' ');
                            if(userText.length > newTitle.length) newTitle += "...";
                            if(userAtts.length > 0 && !userText) newTitle = `Analisis ${userAtts[0].name}`;
                        }

                        return {
                            ...session,
                            title: newTitle,
                            messages: [...session.messages, {
                                id: userMsgId,
                                role: 'user',
                                text: userText,
                                attachments: userAtts,
                                timestamp: getCurrentTime()
                            }]
                        };
                    }
                    return session;
                }));

                setInput("");
                setAttachments([]);
                setIsLoading(true);

                // 2. Prepare Context for API
                // We construct a history prompt from current messages
                const historyContext = currentMessages.map(m => ({
                    role: m.role === 'ai' ? 'model' : 'user',
                    parts: [{ text: m.text }]
                }));
                
                let promptText = userText;
                if(userAtts.length > 0) promptText += `\n[System: User uploaded ${userAtts.length} files: ${userAtts.map(a => a.name).join(', ')}]`;

                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${MODEL}:generateContent?key=${API_KEY}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [...historyContext, { role: 'user', parts: [{ text: promptText }] }],
                            tools: [{ google_search: {} }]
                        })
                    });
                    
                    const data = await res.json();
                    const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || "Maaf, terjadi kesalahan koneksi.";
                    const sources = data.candidates?.[0]?.groundingMetadata?.groundingChunks?.filter(c => c.web?.uri).map(c => ({ title: c.web?.title, uri: c.web?.uri })) || [];
                    const uniqueSources = [...new Map(sources.map(item => [item['uri'], item])).values()];

                    // 3. Update UI with AI Message
                    setSessions(prev => prev.map(session => {
                        if (session.id === activeSessionId) {
                            return {
                                ...session,
                                messages: [...session.messages, {
                                    id: generateId(),
                                    role: 'ai',
                                    text: aiResponse,
                                    sources: uniqueSources,
                                    timestamp: getCurrentTime()
                                }]
                            };
                        }
                        return session;
                    }));

                } catch (error) {
                    setSessions(prev => prev.map(s => s.id === activeSessionId ? {...s, messages: [...s.messages, {id: generateId(), role: 'ai', text: "Error: Gagal menghubungi server.", isError: true}]} : s));
                } finally {
                    setIsLoading(false);
                }
            };

            const renderMarkdown = (text) => ({ __html: marked.parse(text) });

            return (
                <div className="flex h-screen w-full relative overflow-hidden">
                    
                    <DrivePickerModal isOpen={showDrive} onClose={() => setShowDrive(false)} onSelect={handleDriveSelect} />

                    {/* --- SIDEBAR --- */}
                    <div className={`${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} absolute md:relative z-40 w-80 h-full bg-[var(--bg-sidebar)] border-r border-white/5 flex flex-col transition-transform duration-300 shadow-2xl md:shadow-none`}>
                        
                        {/* Header */}
                        <div className="p-5 flex items-center gap-3 border-b border-white/5">
                            <div className="w-8 h-8 rounded bg-gradient-to-tr from-blue-700 to-cyan-500 flex items-center justify-center shadow-lg shadow-blue-500/20">
                                <i className="fa-solid fa-cube text-white text-xs"></i>
                            </div>
                            <div>
                                <h1 className="font-bold text-sm text-white tracking-wide">MetrologyPro</h1>
                                <p className="text-[10px] text-gray-500">Workspace</p>
                            </div>
                            <button onClick={() => setIsSidebarOpen(false)} className="md:hidden ml-auto text-gray-400"><i className="fa-solid fa-xmark"></i></button>
                        </div>

                        {/* New Chat Button */}
                        <div className="p-4">
                            <button onClick={createNewSession} className="w-full flex items-center justify-center gap-2 bg-[#1e1e22] hover:bg-[#27272a] border border-white/10 text-white py-2.5 rounded-lg text-sm font-medium transition-all shadow-sm">
                                <i className="fa-solid fa-plus text-blue-500"></i>
                                <span>Chat Baru</span>
                            </button>
                        </div>

                        {/* History List */}
                        <div className="flex-1 overflow-y-auto px-4 py-2 space-y-1 scroller">
                            <p className="text-[10px] font-bold text-gray-600 uppercase tracking-widest mb-2 px-1">Riwayat</p>
                            {sessions.map(session => (
                                <HistoryItem 
                                    key={session.id} 
                                    session={session} 
                                    isActive={activeSessionId === session.id} 
                                    onClick={() => { setActiveSessionId(session.id); if(window.innerWidth < 768) setIsSidebarOpen(false); }}
                                    onDelete={() => deleteSession(session.id)}
                                />
                            ))}
                        </div>

                        {/* User Profile Footer */}
                        <div className="p-4 border-t border-white/5 bg-[#0a0a0c]">
                            {!user ? (
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-2 opacity-60">
                                        <div className="w-8 h-8 rounded-full bg-gray-800 flex items-center justify-center"><i className="fa-solid fa-user text-xs"></i></div>
                                        <div className="text-xs">Guest Mode</div>
                                    </div>
                                    <button onClick={handleLogin} className="text-xs bg-blue-600 text-white px-3 py-1.5 rounded hover:bg-blue-500">Login</button>
                                </div>
                            ) : (
                                <div className="flex items-center justify-between">
                                    <div className="flex items-center gap-3">
                                        <img src={user.avatar} className="w-8 h-8 rounded-full border border-blue-500/30" />
                                        <div className="overflow-hidden">
                                            <p className="text-xs font-bold text-white truncate w-24">{user.name}</p>
                                            <p className="text-[10px] text-gray-500 truncate w-24">Google Account</p>
                                        </div>
                                    </div>
                                    <button onClick={() => setUser(null)} className="text-gray-500 hover:text-red-400"><i className="fa-solid fa-right-from-bracket"></i></button>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* --- MAIN CHAT AREA --- */}
                    <div className="flex-1 flex flex-col h-full bg-[#09090b] relative">
                        
                        {/* Mobile Header */}
                        <div className="md:hidden flex items-center justify-between p-4 border-b border-white/5 bg-[#09090b]/80 backdrop-blur z-20">
                            <div className="font-bold text-white text-sm">MetrologyPro</div>
                            <button onClick={() => setIsSidebarOpen(true)} className="text-gray-300"><i className="fa-solid fa-bars"></i></button>
                        </div>

                        {/* Messages */}
                        <div className="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 scroller">
                            {currentMessages.map((msg) => (
                                <div key={msg.id} className={`flex gap-4 max-w-4xl mx-auto ${msg.role === 'user' ? 'justify-end' : ''}`}>
                                    
                                    {msg.role === 'ai' && (
                                        <div className="w-8 h-8 rounded bg-blue-500/10 flex items-center justify-center flex-shrink-0 mt-1 border border-blue-500/20">
                                            <i className="fa-solid fa-robot text-blue-400 text-xs"></i>
                                        </div>
                                    )}

                                    <div className={`flex flex-col gap-1 max-w-[85%] md:max-w-[70%] ${msg.role === 'user' ? 'items-end' : 'items-start'}`}>
                                        <div className="flex items-center gap-2 mb-1 px-1">
                                            <span className="text-[10px] text-gray-500">{msg.role === 'user' ? 'Anda' : 'Metrology AI'} • {msg.timestamp}</span>
                                        </div>

                                        {/* Attachments Bubble */}
                                        {msg.attachments && msg.attachments.length > 0 && (
                                            <div className="flex gap-2 mb-2 flex-wrap justify-end">
                                                {msg.attachments.map((att, idx) => (
                                                    <div key={idx} className="bg-[#18181b] border border-white/10 rounded p-1.5 flex items-center gap-2 pr-3">
                                                        {att.type === 'image' && att.preview ? (
                                                            <img src={att.preview} className="h-8 w-8 rounded object-cover" />
                                                        ) : (
                                                            <div className={`w-8 h-8 rounded flex items-center justify-center ${att.type.includes('pdf') ? 'bg-red-500/10 text-red-400' : 'bg-blue-500/10 text-blue-400'}`}>
                                                                <i className={`fa-solid ${att.type.includes('pdf') ? 'fa-file-pdf' : att.type === 'image' ? 'fa-image' : 'fa-file'}`}></i>
                                                            </div>
                                                        )}
                                                        <div className="flex flex-col">
                                                            <span className="text-[10px] text-gray-300 max-w-[120px] truncate">{att.name}</span>
                                                            {att.fromDrive && <span className="text-[9px] text-green-500 flex items-center gap-1"><i className="fa-brands fa-google-drive"></i> Drive</span>}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        )}

                                        <div className={`p-4 rounded-2xl text-sm shadow-sm border ${msg.role === 'user' ? 'bg-blue-600 text-white rounded-tr-none border-blue-500' : 'glass text-gray-200 rounded-tl-none border-white/5'}`}>
                                            <div className="prose prose-sm prose-invert max-w-none" dangerouslySetInnerHTML={renderMarkdown(msg.text)}></div>
                                            
                                            {/* Sources */}
                                            {msg.sources && msg.sources.length > 0 && (
                                                <div className="mt-3 pt-3 border-t border-white/10">
                                                    <div className="flex flex-wrap gap-2">
                                                        {msg.sources.map((src, idx) => (
                                                            <a key={idx} href={src.uri} target="_blank" className="flex items-center gap-1.5 px-2 py-1 bg-black/20 hover:bg-black/40 rounded border border-white/10 text-[10px] text-blue-300 transition-colors no-underline">
                                                                <i className="fa-solid fa-link text-[8px]"></i> {src.title}
                                                            </a>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            ))}
                            {isLoading && (
                                <div className="flex gap-4 max-w-4xl mx-auto">
                                    <div className="w-8 h-8 rounded bg-transparent flex items-center justify-center mt-1">
                                        <i className="fa-solid fa-robot text-gray-600 text-xs"></i>
                                    </div>
                                    <div className="glass px-4 py-3 rounded-2xl rounded-tl-none flex items-center gap-1.5">
                                        <div className="w-1.5 h-1.5 bg-blue-500 rounded-full typing-dot"></div>
                                        <div className="w-1.5 h-1.5 bg-blue-500 rounded-full typing-dot"></div>
                                        <div className="w-1.5 h-1.5 bg-blue-500 rounded-full typing-dot"></div>
                                    </div>
                                </div>
                            )}
                            <div ref={messagesEndRef} />
                        </div>

                        {/* Input Area */}
                        <div className="p-4 md:p-6 z-30">
                            <div className="max-w-4xl mx-auto relative glass-popover rounded-2xl p-2">
                                
                                {/* Popup Menu */}
                                {isMenuOpen && (
                                    <div ref={menuRef} className="absolute bottom-full left-0 mb-3 bg-[#18181b] border border-white/10 rounded-xl shadow-2xl overflow-hidden min-w-[200px] animate-slide-up flex flex-col z-50">
                                        <button onClick={() => { if(!user) { alert('Login dulu bosku'); return; } setShowDrive(true); setIsMenuOpen(false); }} className={`flex items-center gap-3 px-4 py-3 hover:bg-white/5 border-b border-white/5 text-left ${!user && 'opacity-50'}`}>
                                            <div className="w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center text-green-400"><i className="fa-brands fa-google-drive"></i></div>
                                            <div><div className="text-sm font-medium text-white">Google Drive</div><div className="text-[10px] text-gray-500">Cloud Storage</div></div>
                                        </button>
                                        <button onClick={() => pdfInputRef.current.click()} className="flex items-center gap-3 px-4 py-3 hover:bg-white/5 border-b border-white/5 text-left">
                                            <div className="w-8 h-8 rounded-full bg-red-500/20 flex items-center justify-center text-red-400"><i className="fa-solid fa-file-pdf"></i></div>
                                            <div><div className="text-sm font-medium text-white">Upload PDF</div><div className="text-[10px] text-gray-500">Regulasi & Dokumen</div></div>
                                        </button>
                                        <button onClick={() => fileInputRef.current.click()} className="flex items-center gap-3 px-4 py-3 hover:bg-white/5 text-left">
                                            <div className="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400"><i className="fa-solid fa-image"></i></div>
                                            <div><div className="text-sm font-medium text-white">Upload Foto</div><div className="text-[10px] text-gray-500">Analisis Visual</div></div>
                                        </button>
                                    </div>
                                )}

                                {/* Hidden Inputs */}
                                <input type="file" ref={fileInputRef} onChange={(e) => handleFileSelect(e, 'image')} className="hidden" accept="image/*" />
                                <input type="file" ref={pdfInputRef} onChange={(e) => handleFileSelect(e, 'pdf')} className="hidden" accept=".pdf" />

                                {/* Preview Attachments */}
                                {attachments.length > 0 && (
                                    <div className="flex gap-2 p-2 mb-1 border-b border-white/5 overflow-x-auto">
                                        {attachments.map((att, idx) => (
                                            <div key={idx} className="relative bg-[#09090b] rounded p-1 border border-white/10 group">
                                                {att.type === 'image' && att.preview ? <img src={att.preview} className="h-10 w-10 object-cover rounded" /> : <div className="h-10 w-10 flex items-center justify-center bg-gray-800 rounded text-gray-400"><i className={`fa-solid ${att.type.includes('pdf') ? 'fa-file-pdf' : 'fa-file'}`}></i></div>}
                                                <button onClick={() => setAttachments(prev => prev.filter((_, i) => i !== idx))} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-[10px]"><i className="fa-solid fa-xmark"></i></button>
                                            </div>
                                        ))}
                                    </div>
                                )}

                                <form onSubmit={handleSend} className="flex items-end gap-2">
                                    <button type="button" onClick={() => setIsMenuOpen(!isMenuOpen)} className={`p-3 rounded-xl transition-all ${isMenuOpen ? 'bg-blue-600 text-white rotate-45' : 'text-gray-400 hover:text-white hover:bg-white/5'}`}><i className="fa-solid fa-plus text-lg"></i></button>
                                    <textarea value={input} onChange={(e) => setInput(e.target.value)} onKeyDown={(e) => { if(e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(e); }}} placeholder={user ? "Ketik pesan, atau gunakan file Drive..." : "Ketik pesan..."} className="w-full bg-transparent border-none text-gray-200 placeholder-gray-500 focus:ring-0 resize-none max-h-32 min-h-[48px] py-3.5 text-sm" rows="1" style={{height:'auto'}}></textarea>
                                    <button type="submit" disabled={!input.trim() && attachments.length === 0 || isLoading} className="p-3 bg-blue-600 hover:bg-blue-500 disabled:bg-white/5 disabled:text-gray-600 text-white rounded-xl transition-all shadow-lg"><i className="fa-solid fa-paper-plane text-sm"></i></button>
                                </form>
                            </div>
                            <p className="text-center text-[10px] text-gray-600 mt-3">Powered by Gemini 2.5 Flash</p>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>

        .prose ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 1em; }
        .prose strong { color: #fff; font-weight: 600; }
        .prose a { color: #60a5fa; text-decoration: underline; }
        .prose blockquote { border-left: 4px solid #475569; padding-left: 1em; color: #94a3b8; font-style: italic; }

        /* Animation */
        @keyframes bounce-delay {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-4px); }
        }
        .animate-bounce-delay { animation: bounce-delay 1s infinite; }
    </style>
</head>
<body class="bg-[#0f172a] text-slate-200 h-screen overflow-hidden selection:bg-blue-500 selection:text-white">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- KONFIGURASI API ---
        const API_KEY = "AIzaSyCHQbkmex1buEVSLGJHMFeSDuH6BQTCE8w";
        const MODEL_NAME = "gemini-2.5-flash-preview-09-2025";

        const MetrologyProApp = () => {
            // State
            const [messages, setMessages] = useState([
                {
                    id: 1,
                    role: 'ai',
                    text: "Halo. Saya **MetrologyPro AI**. \n\nSaya terhubung langsung ke internet untuk memberikan informasi regulasi, teknis, dan berita metrologi terkini.\n\nApa yang bisa saya bantu hari ini?",
                    sources: []
                }
            ]);
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [selectedModel, setSelectedModel] = useState('flash'); // 'flash' or 'pro'
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            
            const messagesEndRef = useRef(null);

            // Auto-scroll
            useEffect(() => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages, isLoading]);

            // Fungsi Kirim Pesan
            const handleSend = async (e) => {
                e.preventDefault();
                if (!input.trim() || isLoading) return;

                const userMessage = { id: Date.now(), role: 'user', text: input };
                setMessages(prev => [...prev, userMessage]);
                setInput('');
                setIsLoading(true);

                try {
                    // 1. History Context (Limit 5 pesan terakhir)
                    const history = messages.slice(-5).map(msg => ({
                        role: msg.role === 'ai' ? 'model' : 'user',
                        parts: [{ text: msg.text }]
                    }));

                    // 2. System Prompt
                    const modeInstruction = selectedModel === 'pro' 
                        ? "Berikan jawaban yang sangat detail, analitis, dan mendalam. Gunakan bahasa formal akademik/pemerintahan."
                        : "Berikan jawaban yang ringkas, padat, dan langsung pada intinya (to-the-point).";

                    const systemPrompt = `
                        Anda adalah MetrologyPro AI, asisten resmi Direktorat Metrologi.
                        Tugas: Menjawab pertanyaan tentang metrologi, hukum, regulasi, dan teknis.
                        
                        INSTRUKSI PENTING:
                        1. Anda memiliki akses ke GOOGLE SEARCH. GUNAKAN ITU untuk mencari data fakta terbaru.
                        2. Jangan mengarang hukum atau pasal. Wajib menyertakan sumber jika mengambil data online.
                        3. Gaya bicara: Profesional, Sopan, Menggunakan istilah baku Bahasa Indonesia.
                        4. Mode saat ini: ${modeInstruction}
                    `;

                    // 3. Panggil API Gemini
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [...history, { role: 'user', parts: [{ text: input }] }],
                                systemInstruction: { parts: [{ text: systemPrompt }] },
                                tools: [{ google_search: {} }],
                                generationConfig: {
                                    temperature: selectedModel === 'pro' ? 0.7 : 0.3,
                                }
                            })
                        }
                    );

                    const data = await response.json();

                    if (!response.ok) throw new Error(data.error?.message || "Gagal menghubungi server");

                    // 4. Ekstrak Data
                    const candidate = data.candidates?.[0];
                    const aiText = candidate?.content?.parts?.[0]?.text || "Maaf, saya tidak menemukan jawaban.";
                    
                    // Ekstrak Sumber (Grounding)
                    const groundingChunks = candidate?.groundingMetadata?.groundingChunks || [];
                    const sources = groundingChunks
                        .filter(chunk => chunk.web?.uri)
                        .map(chunk => ({
                            title: chunk.web?.title || "Sumber Web",
                            uri: chunk.web?.uri
                        }));
                    
                    // Hapus duplikasi sumber
                    const uniqueSources = Array.from(new Set(sources.map(a => a.uri)))
                        .map(uri => sources.find(a => a.uri === uri));

                    const aiMessage = {
                        id: Date.now() + 1,
                        role: 'ai',
                        text: aiText,
                        sources: uniqueSources
                    };

                    setMessages(prev => [...prev, aiMessage]);

                } catch (error) {
                    setMessages(prev => [...prev, {
                        id: Date.now() + 1,
                        role: 'ai',
                        text: `⚠️ **Error Sistem:** ${error.message}. Coba lagi nanti.`,
                        isError: true
                    }]);
                } finally {
                    setIsLoading(false);
                }
            };

            const handleClearChat = () => {
                setMessages([{
                    id: 1,
                    role: 'ai',
                    text: "Halo. Saya **MetrologyPro AI**. \n\nSaya terhubung langsung ke internet untuk memberikan informasi regulasi, teknis, dan berita metrologi terkini.\n\nApa yang bisa saya bantu hari ini?",
                    sources: []
                }]);
                setIsSidebarOpen(false);
            };

            // Render Markdown
            const renderMarkdown = (text) => {
                return { __html: marked.parse(text) };
            };

            return (
                <div className="flex h-screen bg-[#0f172a] text-slate-200 overflow-hidden">
                    
                    {/* --- SIDEBAR --- */}
                    <div className={`fixed inset-y-0 left-0 z-50 w-72 bg-[#1e293b] border-r border-slate-700 transform transition-transform duration-300 ease-in-out md:relative md:translate-x-0 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="flex flex-col h-full">
                            
                            {/* Logo Area */}
                            <div className="p-6 border-b border-slate-700 flex items-center gap-3">
                                <div className="bg-gradient-to-br from-blue-600 to-cyan-400 w-10 h-10 flex items-center justify-center rounded-lg shadow-lg shadow-blue-500/20">
                                    <i className="fa-solid fa-shield-halved text-white text-lg"></i>
                                </div>
                                <div>
                                    <h1 className="font-bold text-lg tracking-wide text-white">Metrology<span className="text-blue-400">Pro</span></h1>
                                    <p className="text-[10px] text-slate-400 uppercase tracking-widest">Direktorat Metrologi</p>
                                </div>
                                <button onClick={() => setIsSidebarOpen(false)} className="md:hidden ml-auto text-slate-400 hover:text-white">
                                    <i className="fa-solid fa-xmark text-xl"></i>
                                </button>
                            </div>

                            {/* Model Selection */}
                            <div className="p-6 flex-1 overflow-y-auto">
                                <h3 className="text-xs font-semibold text-slate-500 uppercase mb-4 tracking-wider">Model AI</h3>
                                
                                <div className="space-y-3">
                                    <button 
                                        onClick={() => setSelectedModel('flash')}
                                        className={`w-full flex items-center gap-3 p-3 rounded-xl border transition-all duration-200 ${selectedModel === 'flash' ? 'bg-blue-600/20 border-blue-500/50 ring-1 ring-blue-500' : 'bg-slate-800/50 border-slate-700 hover:bg-slate-800'}`}
                                    >
                                        <div className={`w-8 h-8 flex items-center justify-center rounded-lg ${selectedModel === 'flash' ? 'bg-blue-500 text-white' : 'bg-slate-700 text-slate-400'}`}>
                                            <i className="fa-solid fa-bolt"></i>
                                        </div>
                                        <div className="text-left">
                                            <div className={`text-sm font-medium ${selectedModel === 'flash' ? 'text-blue-200' : 'text-slate-300'}`}>Gemini Flash</div>
                                            <div className="text-[10px] text-slate-500">Respon Cepat & Ringkas</div>
                                        </div>
                                    </button>

                                    <button 
                                        onClick={() => setSelectedModel('pro')}
                                        className={`w-full flex items-center gap-3 p-3 rounded-xl border transition-all duration-200 ${selectedModel === 'pro' ? 'bg-purple-600/20 border-purple-500/50 ring-1 ring-purple-500' : 'bg-slate-800/50 border-slate-700 hover:bg-slate-800'}`}
                                    >
                                        <div className={`w-8 h-8 flex items-center justify-center rounded-lg ${selectedModel === 'pro' ? 'bg-purple-500 text-white' : 'bg-slate-700 text-slate-400'}`}>
                                            <i className="fa-solid fa-wand-magic-sparkles"></i>
                                        </div>
                                        <div className="text-left">
                                            <div className={`text-sm font-medium ${selectedModel === 'pro' ? 'text-purple-200' : 'text-slate-300'}`}>Gemini Pro</div>
                                            <div className="text-[10px] text-slate-500">Analisis Mendalam</div>
                                        </div>
                                    </button>
                                </div>

                                <div className="mt-8">
                                    <h3 className="text-xs font-semibold text-slate-500 uppercase mb-4 tracking-wider">Status Sistem</h3>
                                    <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700 space-y-3">
                                        <div className="flex items-center justify-between text-xs">
                                            <span className="text-slate-400">Koneksi Internet</span>
                                            <span className="text-green-400 flex items-center gap-1"><span className="w-1.5 h-1.5 bg-green-400 rounded-full animate-pulse"></span> Online</span>
                                        </div>
                                        <div className="flex items-center justify-between text-xs">
                                            <span className="text-slate-400">Google Search</span>
                                            <span className="text-blue-400">Aktif</span>
                                        </div>
                                        <div className="flex items-center justify-between text-xs">
                                            <span className="text-slate-400">API Key</span>
                                            <span className="text-slate-200 font-mono bg-slate-900 px-1 rounded">AIzaSy...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Footer Sidebar */}
                            <div className="p-4 border-t border-slate-700">
                                <button onClick={handleClearChat} className="flex items-center justify-center gap-2 w-full p-2 text-sm text-red-400 hover:bg-red-900/20 hover:text-red-300 rounded-lg transition-colors">
                                    <i className="fa-solid fa-trash-can"></i>
                                    <span>Reset Percakapan</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* --- MAIN CHAT AREA --- */}
                    <div className="flex-1 flex flex-col relative w-full max-w-full">
                        
                        {/* Header Mobile */}
                        <div className="md:hidden p-4 bg-[#0f172a] border-b border-slate-700 flex justify-between items-center z-10 sticky top-0">
                            <div className="flex items-center gap-2">
                                <i className="fa-solid fa-shield-halved text-blue-500"></i>
                                <span className="font-bold text-slate-200">MetrologyPro</span>
                            </div>
                            <button onClick={() => setIsSidebarOpen(true)} className="text-slate-300">
                                <i className="fa-solid fa-bars text-xl"></i>
                            </button>
                        </div>

                        {/* Messages Container */}
                        <div className="flex-1 overflow-y-auto p-4 md:p-8 space-y-6 custom-scrollbar scroll-smooth">
                            {messages.map((msg) => (
                                <div key={msg.id} className={`flex gap-4 max-w-4xl mx-auto ${msg.role === 'user' ? 'justify-end' : ''}`}>
                                    
                                    {/* Avatar AI */}
                                    {msg.role === 'ai' && (
                                        <div className="w-10 h-10 rounded-full bg-gradient-to-br from-blue-600 to-cyan-500 flex items-center justify-center flex-shrink-0 shadow-lg shadow-blue-900/20">
                                            <i className="fa-solid fa-robot text-white"></i>
                                        </div>
                                    )}

                                    {/* Chat Bubble */}
                                    <div className={`flex flex-col gap-2 max-w-[85%] md:max-w-[75%]`}>
                                        <div className={`text-xs font-bold ${msg.role === 'user' ? 'text-right text-slate-400' : 'text-blue-400'} mb-1`}>
                                            {msg.role === 'user' ? 'Anda' : 'MetrologyPro AI'}
                                        </div>
                                        
                                        <div className={`p-4 md:p-6 rounded-2xl text-sm leading-relaxed shadow-md 
                                            ${msg.role === 'user' 
                                                ? 'bg-blue-600 text-white rounded-tr-none' 
                                                : 'bg-[#1e293b] text-slate-200 border border-slate-700 rounded-tl-none'
                                            }`}>
                                            
                                            {/* Render Markdown Content */}
                                            <div className="prose prose-sm max-w-none" dangerouslySetInnerHTML={renderMarkdown(msg.text)}></div>

                                            {/* Sources Section (If Any) */}
                                            {msg.sources && msg.sources.length > 0 && (
                                                <div className="mt-4 pt-4 border-t border-slate-600/50">
                                                    <div className="flex items-center gap-2 text-xs font-semibold text-slate-400 mb-2">
                                                        <i className="fa-solid fa-magnifying-glass"></i>
                                                        <span>Sumber Referensi Web:</span>
                                                    </div>
                                                    <div className="flex flex-wrap gap-2">
                                                        {msg.sources.map((src, idx) => (
                                                            <a 
                                                                key={idx} 
                                                                href={src.uri} 
                                                                target="_blank" 
                                                                rel="noopener noreferrer"
                                                                className="flex items-center gap-1.5 px-3 py-1.5 bg-slate-800 hover:bg-slate-700 border border-slate-600 rounded-full text-xs text-blue-300 transition-colors truncate max-w-[200px]"
                                                            >
                                                                <i className="fa-solid fa-up-right-from-square text-[10px]"></i>
                                                                <span className="truncate">{src.title}</span>
                                                            </a>
                                                        ))}
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </div>

                                    {/* Avatar User */}
                                    {msg.role === 'user' && (
                                        <div className="w-10 h-10 rounded-full bg-slate-700 border border-slate-600 flex items-center justify-center flex-shrink-0">
                                            <i className="fa-solid fa-user text-slate-400"></i>
                                        </div>
                                    )}
                                </div>
                            ))}

                            {/* Loading Indicator */}
                            {isLoading && (
                                <div className="flex gap-4 max-w-4xl mx-auto animate-pulse">
                                    <div className="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center border border-slate-700">
                                        <i className="fa-solid fa-robot text-slate-500"></i>
                                    </div>
                                    <div className="bg-[#1e293b] border border-slate-700 px-6 py-4 rounded-2xl rounded-tl-none flex items-center gap-2">
                                        <div className="w-2 h-2 bg-blue-500 rounded-full animate-bounce-delay" style={{animationDelay: '0s'}}></div>
                                        <div className="w-2 h-2 bg-blue-500 rounded-full animate-bounce-delay" style={{animationDelay: '0.2s'}}></div>
                                        <div className="w-2 h-2 bg-blue-500 rounded-full animate-bounce-delay" style={{animationDelay: '0.4s'}}></div>
                                        <span className="text-xs text-slate-400 ml-2">Mencari data di internet...</span>
                                    </div>
                                </div>
                            )}
                            
                            <div ref={messagesEndRef} />
                        </div>

                        {/* Input Area */}
                        <div className="p-4 md:p-6 bg-[#0f172a] border-t border-slate-700 z-20">
                            <div className="max-w-4xl mx-auto">
                                <form onSubmit={handleSend} className="relative flex items-end gap-2 p-2 bg-[#1e293b] border border-slate-600 rounded-xl focus-within:ring-2 focus-within:ring-blue-500 focus-within:border-transparent transition-all shadow-lg shadow-black/20">
                                    
                                    <textarea
                                        value={input}
                                        onChange={(e) => setInput(e.target.value)}
                                        onKeyDown={(e) => {
                                            if (e.key === 'Enter' && !e.shiftKey) {
                                                e.preventDefault();
                                                handleSend(e);
                                            }
                                        }}
                                        placeholder="Tanyakan tentang regulasi tera, standar ukuran, atau berita metrologi terbaru..."
                                        className="w-full bg-transparent border-none text-slate-200 placeholder-slate-500 focus:ring-0 resize-none max-h-32 min-h-[44px] py-3 px-3 text-sm focus:outline-none"
                                        rows="1"
                                        style={{ height: 'auto', minHeight: '44px' }}
                                    ></textarea>
                                    
                                    <button 
                                        type="submit" 
                                        disabled={!input.trim() || isLoading}
                                        className="mb-1 p-2.5 bg-blue-600 hover:bg-blue-500 disabled:bg-slate-700 disabled:text-slate-500 text-white rounded-lg transition-all flex-shrink-0 shadow-md cursor-pointer disabled:cursor-not-allowed"
                                    >
                                        <i className="fa-solid fa-paper-plane text-lg"></i>
                                    </button>
                                </form>
                                <div className="mt-2 text-center">
                                    <p className="text-[10px] text-slate-500 flex items-center justify-center gap-1.5">
                                        <i className="fa-solid fa-bolt text-yellow-500"></i>
                                        Didukung oleh Google Gemini 2.5 Flash & Google Search Grounding
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MetrologyProApp />);
    </script>
</body>
</html>

